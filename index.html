<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hebrew AR Alphabet Trainer — MVP</title>
  <style>
    :root { --bg:#0f1220; --panel:#171a2b; --ink:#e6e9ff; --muted:#9aa0c3; --accent:#6ea8fe; --ok:#3ddc84; --bad:#ff6b6b; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:var(--ink); background: radial-gradient(1200px 800px at 70% -10%, #223 0, #0b0d18 60%, #06070e 100%); }
    header { padding:18px 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid #262a44; backdrop-filter:saturate(140%) blur(8px); position:sticky; top:0; z-index:9; }
    header h1 { margin:0; font-size:18px; font-weight:650; letter-spacing:.2px; }
    header .hint { color:var(--muted); font-size:13px; }
    .wrap { display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; padding:16px; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid #242741; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); overflow:hidden; }
    .card header { position:unset; border:0; background:linear-gradient(180deg, rgba(255,255,255,.04), transparent); }
    .cam { position:relative; height:58vh; min-height:360px; }
    #video { width:100%; height:100%; object-fit:cover; background:#000; }
    #overlay { position:absolute; inset:0; pointer-events:none; }
    .controls { display:flex; gap:10px; padding:12px 16px 16px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid #2b2f52; background:linear-gradient(180deg, #2a2f52, #1b1f3a); color:#fff; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s transform,.2s filter; }
    .btn:hover { filter:brightness(1.05); transform:translateY(-1px); }
    .btn:active { transform:translateY(0); }
    .btn.primary { background:linear-gradient(180deg, #6ea8fe, #456bd6); border-color:#4a74e0; color:#081028; }
    .btn.ghost { background:transparent; }
    .row { display:flex; align-items:center; gap:10px; }
    .muted { color:var(--muted); font-size:13px; }
    .list { padding:12px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; max-height:60vh; overflow:auto; }
    .snap { background:#111428; border:1px solid #242a4a; border-radius:14px; overflow:hidden; display:grid; grid-template-rows: auto auto; }
    .snap img { width:100%; height:140px; object-fit:cover; display:block; }
    .snap .meta { padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #334; color:#cfe; background:rgba(110,168,254,.08); }
    .snap button { margin-left:auto; }

    /* Quiz */
    .quiz { padding:12px; display:grid; gap:12px; }
    .quiz .word { font-size:22px; font-weight:700; text-align:center; }
    .opts { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .opt { padding:16px 8px; border-radius:14px; border:1px solid #2b2f52; text-align:center; font-size:28px; font-weight:800; cursor:pointer; background:linear-gradient(180deg, #1b1f3a, #151834); }
    .opt .play { display:block; font-size:12px; margin-top:6px; color:var(--muted); }
    .opt.correct { outline:3px solid var(--ok); box-shadow:0 0 0 4px rgba(61,220,132,.15) inset; }
    .opt.wrong { outline:3px solid var(--bad); box-shadow:0 0 0 4px rgba(255,107,107,.12) inset; }
    .status { text-align:center; font-weight:700; }
    .status.ok { color:var(--ok); }
    .status.bad { color:var(--bad); }
    footer { padding:10px 16px; color:#9aa0c3; font-size:12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#202545; border:1px solid #334; padding:1px 6px; border-radius:6px; }
  </style>
  <!-- TensorFlow.js + COCO-SSD (client-side object detection) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
</head>
<body>
  <header>
    <h1>Hebrew AR Alphabet Trainer</h1>
    <div class="hint">Point the camera at an object, then <span class="kbd">Capture</span> → quiz by tapping a snapshot.</div>
  </header>

  <div class="wrap">
    <!-- LEFT: Camera + detections -->
    <section class="card">
      <header>
        <h2 style="font-size:16px; font-weight:700; margin:0 16px 10px;">Camera</h2>
      </header>
      <div class="cam">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
      <div class="controls">
        <button class="btn primary" id="btnCapture">📸 Capture</button>
        <button class="btn ghost" id="btnSpeak">🔊 Speak object (Hebrew)</button>
        <div class="row muted">Top detection: <span id="curDet" style="font-weight:700; color:#dfe4ff; margin-left:6px;">—</span></div>
      </div>
      <footer>
        Tip: On desktop, use Chrome. If the camera doesn't start, serve over HTTPS or use <span class="kbd">localhost</span>.
      </footer>
    </section>

    <!-- RIGHT: Quiz + Snapshots -->
    <section class="card" style="display:grid; grid-template-rows: auto 1fr;">
      <header>
        <h2 style="font-size:16px; font-weight:700; margin:0 16px 10px;">Quiz</h2>
      </header>
      <div class="quiz" id="quiz">
        <div class="word" id="quizWord">Take a snapshot to start →</div>
        <div class="opts" id="opts"></div>
        <div class="status" id="status"></div>
      </div>
    </section>
  </div>

  <section class="card" style="margin:0 16px 16px;">
    <header>
      <h2 style="font-size:16px; font-weight:700; margin:0 16px 10px;">Your snapshots</h2>
    </header>
    <div class="list" id="list"></div>
  </section>

  <script>
    // --- Hebrew dictionary for common COCO-SSD labels ---
    const HEBREW_DICT = {
      "cup": { word: "כוס", letter: "כ" },
      "chair": { word: "כיסא", letter: "כ" },
      "bottle": { word: "בקבוק", letter: "ב" },
      "bowl": { word: "קערה", letter: "ק" },
      "spoon": { word: "כפית", letter: "כ" },
      "fork": { word: "מזלג", letter: "מ" },
      "knife": { word: "סכין", letter: "ס" },
      "banana": { word: "בננה", letter: "ב" },
      "apple": { word: "תפוח", letter: "ת" },
      "orange": { word: "תפוז", letter: "ת" },
      "pizza": { word: "פיצה", letter: "פ" },
      "cake": { word: "עוגה", letter: "ע" },
      "couch": { word: "ספה", letter: "ס" },
      "potted plant": { word: "עציץ", letter: "ע" },
      "bed": { word: "מיטה", letter: "מ" },
      "dining table": { word: "שולחן", letter: "ש" },
      "toilet": { word: "אסלה", letter: "א" },
      "tv": { word: "טלוויזיה", letter: "ט" },
      "laptop": { word: "מחשב", letter: "מ" },
      "mouse": { word: "עכבר", letter: "ע" },
      "remote": { word: "שלט", letter: "ש" },
      "keyboard": { word: "מקלדת", letter: "מ" },
      "cell phone": { word: "טלפון", letter: "ט" },
      "microwave": { word: "מיקרוגל", letter: "מ" },
      "oven": { word: "תנור", letter: "ת" },
      "sink": { word: "כיור", letter: "כ" },
      "refrigerator": { word: "מקרר", letter: "מ" },
      "book": { word: "ספר", letter: "ס" },
      "clock": { word: "שעון", letter: "ש" },
      "vase": { word: "אגרטל", letter: "א" },
      "scissors": { word: "מספריים", letter: "מ" },
      "toothbrush": { word: "מברשת שיניים", letter: "מ" }
    };

    // Hebrew alphabet (main forms)
    const HEB_LETTERS = ["א","ב","ג","ד","ה","ו","ז","ח","ט","י","כ","ל","מ","נ","ס","ע","פ","צ","ק","ר","ש","ת"];
    const HEB_LETTER_NAMES = { // for TTS
      "א":"אלף","ב":"בית","ג":"גימל","ד":"דלת","ה":"הא","ו":"וו","ז":"זין","ח":"חית","ט":"טית","י":"יוד","כ":"כף","ל":"למד","מ":"מם","נ":"נון","ס":"סמך","ע":"עין","פ":"פה","צ":"צדי","ק":"קוף","ר":"ריש","ש":"שין","ת":"תו"
    };

    // --- Camera & detection setup ---
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const curDet = document.getElementById('curDet');

    let model = null;
    let lastDetections = [];

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      await new Promise(res => video.onloadedmetadata = res);
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
    }

    function drawDetections(dets){
      ctx.clearRect(0,0,overlay.width, overlay.height);
      const top = dets[0];
      if(top){
        curDet.textContent = `${top.class} (${(top.score*100|0)}%)`;
      } else {
        curDet.textContent = '—';
      }
      dets.forEach(d => {
        const [x,y,w,h] = d.bbox; // coco-ssd bbox
        ctx.strokeStyle = 'rgba(110,168,254,0.95)';
        ctx.lineWidth = 3;
        ctx.strokeRect(x,y,w,h);
        ctx.fillStyle = 'rgba(6,10,30,0.75)';
        ctx.fillRect(x, y-26, ctx.measureText(d.class).width+16, 22);
        ctx.fillStyle = '#cfe0ff';
        ctx.font = '16px ui-sans-serif, system-ui, -apple-system, Segoe UI';
        ctx.fillText(d.class, x+8, y-10);
      });
    }

    async function detectLoop(){
      if(!model) return;
      lastDetections = await model.detect(video);
      drawDetections(lastDetections);
      requestAnimationFrame(detectLoop);
    }

    // --- TTS helpers ---
    function speak(text, lang='he-IL'){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = lang;
      u.rate = 0.95; // a bit slower for kids
      speechSynthesis.speak(u);
    }

    function speakLetter(letter){
      const name = HEB_LETTER_NAMES[letter] || letter;
      speak(name, 'he-IL');
    }

    // --- Snapshots & Quiz ---
    const list = document.getElementById('list');
    const quizWord = document.getElementById('quizWord');
    const opts = document.getElementById('opts');
    const statusEl = document.getElementById('status');

    const snapshots = [];

    function dataURLFromVideo(){
      const c = document.createElement('canvas');
      c.width = overlay.width; c.height = overlay.height;
      const cx = c.getContext('2d');
      cx.drawImage(video, 0, 0, c.width, c.height);
      return c.toDataURL('image/jpeg', 0.85);
    }

    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

    function threeLetterOptions(correct){
      const pool = HEB_LETTERS.filter(l => l !== correct);
      const picked = shuffle(pool).slice(0,2);
      return shuffle([correct, ...picked]);
    }

    function renderList(){
      list.innerHTML = '';
      snapshots.forEach((s, idx) => {
        const card = document.createElement('div');
        card.className = 'snap';
        const img = document.createElement('img');
        img.src = s.img;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<span>${s.heWord} <span class="tag">${s.enLabel}</span></span>`;
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = '▶ Quiz';
        btn.onclick = () => startQuiz(s);
        meta.appendChild(btn);
        card.appendChild(img);
        card.appendChild(meta);
        list.appendChild(card);
      });
    }

    function startQuiz(snap){
      statusEl.textContent = '';
      quizWord.textContent = snap.heWord;
      // Speak the full word
      speak(snap.heWord, 'he-IL');
      const options = threeLetterOptions(snap.firstLetter);
      opts.innerHTML = '';
      options.forEach(letter => {
        const b = document.createElement('button');
        b.className = 'opt';
        b.innerHTML = `${letter}<span class="play">השמע את האות</span>`;
        b.onclick = () => {
          speakLetter(letter);
          if(letter === snap.firstLetter){
            b.classList.add('correct');
            statusEl.textContent = 'כל הכבוד! נכון ✅';
            statusEl.className = 'status ok';
          } else {
            b.classList.add('wrong');
            statusEl.textContent = `כמעט! האות הנכונה היא "${snap.firstLetter}"`;
            statusEl.className = 'status bad';
          }
        };
        // play-only when pressing the small caption
        b.querySelector('.play').addEventListener('click', (ev) => {
          ev.stopPropagation();
          speakLetter(letter);
        });
        opts.appendChild(b);
      });
    }

    // --- UI buttons ---
    document.getElementById('btnCapture').addEventListener('click', () => {
      const top = lastDetections[0];
      if(!top){
        statusEl.textContent = 'לא זוהה אובייקט — נסו שוב';
        statusEl.className = 'status bad';
        return;
      }
      const enLabel = top.class;
      const heb = HEBREW_DICT[enLabel];
      if(!heb){
        statusEl.textContent = `אין עדיין מילה בעברית ל- ${enLabel} — נסו חפץ אחר`;
        statusEl.className = 'status bad';
        return;
      }
      const img = dataURLFromVideo();
      const snap = { enLabel, heWord: heb.word, firstLetter: heb.letter, img };
      snapshots.unshift(snap);
      renderList();
      startQuiz(snap);
    });

    document.getElementById('btnSpeak').addEventListener('click', () => {
      const top = lastDetections[0];
      if(!top) return;
      const heb = HEBREW_DICT[top.class];
      if(heb) speak(heb.word, 'he-IL');
    });

    // --- Boot ---
    (async () => {
      try {
        await initCamera();
        model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
        detectLoop();
      } catch (err){
        alert('Camera or ML model failed to start. Try Chrome on desktop/mobile and allow camera access.\n'+err);
        console.error(err);
      }
    })();
  </script>
</body>
</html>
